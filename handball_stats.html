
<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Håndball – Enkel kampstatistikk</title>
  <style>
    :root{ --bg:#0b1220; --panel:#121a2b; --accent:#4cc9f0; --text:#e6f1ff; --muted:#9fb3c8; --bad:#ef476f; --ok:#06d6a0; --warn:#ffd166; --star:#ffd166; }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    header{padding:12px 16px;background:linear-gradient(90deg,var(--panel),#0f1a33);display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px;flex:1}
    main{padding:16px;max-width:1100px;margin:auto}
    .grid{display:grid;gap:12px}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    input[type="text"],input[type="number"],select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2a3a5c;background:#0f1730;color:var(--text)}
    .btn{appearance:none;border:1px solid #244; background:#0f1730; color:#e6f1ff; padding:12px 14px; border-radius:10px; cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#2895be); border-color:#1d6b87; color:#062231; font-weight:700}
    .btn.success{background:linear-gradient(180deg,var(--ok),#0ab77f); border-color:#0a8f66; color:#062231; font-weight:700}
    .btn.warn{background:linear-gradient(180deg,var(--warn),#e3b23b); border-color:#b9902f; color:#3d2b00; font-weight:700}
    .btn.danger{background:linear-gradient(180deg,var(--bad),#cc3557); border-color:#9c2a44; color:#33010f; font-weight:700}
    .btn.ghost{background:transparent;border-color:#2a3a5c}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .timer{font-variant-numeric:tabular-nums;font-size:40px;font-weight:800;letter-spacing:1px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0b1430;border:1px solid #2a3a5c;color:var(--muted);font-size:12px}

    /* Roster grid + badges */
    .roster-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .badge{padding:10px;border:1px solid #1f2a44;border-radius:12px;background:#0e1833;display:flex;flex-direction:column;gap:6px}
    .badge.active{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(76,201,240,.2)}
    .badge .top{display:flex;align-items:center;gap:8px}
    .badge .nm{font-weight:700}
    .badge .starbtn{margin-left:auto}

    /* Player cards */
    .player-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .player{padding:12px;border:1px solid #1f2a44;border-radius:12px;background:#0e1833}
    .player h4{margin:0 0 6px 0; display:flex; align-items:center; gap:8px}
    .starbtn{border:none;background:transparent;padding:0;cursor:pointer;font-size:18px;line-height:18px;color:#2a3a5c}
    .starbtn.on{color:var(--star)}
    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px}
    .actions .btn{padding:16px 12px;font-size:15px}
    @media(max-width:560px){.actions{grid-template-columns:1fr 1fr}.actions .btn{padding:18px 14px;font-size:16px}}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #22324f}
    tr:hover{background:#0f1a35}
    .kpi{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .kpi .k{background:#0e1833;border:1px solid #1f2a44;border-radius:12px;padding:10px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .sticky-footer{position:sticky;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(11,18,32,0),var(--bg) 25%);padding:12px 0;margin-top:8px}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0e1833;border:1px solid #1f2a44;color:#e6f1ff;border-radius:12px;padding:10px 14px;z-index:2000;display:none;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .toast.show{display:block;animation:fadein .2s ease-out}
    @keyframes fadein{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
    .modal .content{width:min(800px,92vw);background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}

    .zone-wrap{width:100%}
    svg.zone{width:100%;height:auto;border-radius:20px;background:#7bb7da}
    .goal{fill:#0d4166}
    .nine{fill:none;stroke:#ffffff;stroke-dasharray:8 6;opacity:.9}
    .six{fill:none;stroke:#b11c4a;stroke-width:3}
    .numbtn circle{fill:rgba(0,0,0,0);stroke:rgba(0,0,0,0)}
    .numbtn:hover circle{fill:rgba(76,201,240,.12)}
    .numbtn.selected circle{fill:rgba(76,201,240,.55);stroke:var(--accent);stroke-width:2.5}
    .numbtn text{font-size:22px;fill:#fff;font-weight:800;text-anchor:middle;dominant-baseline:middle}

    .bar{height:12px;border-radius:999px;background:#0f1730;border:1px solid #2a3a5c;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#0ab77f)}
    .bar.bad > span{background:linear-gradient(90deg,var(--bad),#cc3557)}
  </style>
</head>
<body>
  <header>
    <h1>Håndball – Enkel kampstatistikk</h1>
  </header>
  <main>
    <section id="setup" class="grid grid-2">
      <div class="card">
        <h2 style="margin-top:0">1) Kampdetaljer</h2>
        <label>Konkurranse
          <select id="competition" onchange="onCompetitionChange()">
            <option value="Regional">Regional</option>
            <option value="Lokal">Lokal</option>
            <option value="Annet" selected>Annet</option>
          </select>
        </label>
        <label>Motstander (valgfritt)
          <input id="opponent" type="text" placeholder="Lag" />
        </label>
        <label>Merknader (valgfritt)
          <input id="notes" type="text" placeholder="Serie, treningskamp, osv." />
        </label>
        <div class="row" style="align-items:center;justify-content:space-between;margin-top:8px">
          <div style="flex:1">
            <label>Periodelengde (minutter)
              <input id="periodMinutes" type="number" min="1" max="60" value="30" />
            </label>
            <div class="small muted">Regional/Lokal: automatisk 25 min. Annet: valgfritt.</div>
          </div>
          <div><span class="pill">To omganger</span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost" onclick="loadFromLocal()">Last inn sist lagret</button>
          <button class="btn ghost" onclick="clearLocal()">Tøm lokalt</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0">2) Velg spillere som deltar</h2>
        <div id="rosterList" class="roster-list"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn success" onclick="markFieldPlayersAttending()">Marker alle utespillere</button>
          <button class="btn" onclick="selectNone()">Fjern deltakelse</button>
          <button class="btn ghost" onclick="markAllAttending()">Marker alle</button>
        </div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h2 style="margin-top:0">3) Start kamp</h2>
        <div class="row">
          <button class="btn primary" onclick="startGame()">Start kamp (til 1. omgang)</button>
          <button class="btn ghost" onclick="openSummary(true)">Vis pauseoppsummering</button>
        </div>
        <p class="small muted">Tips: du kan gå tilbake til oppsett før innsending.</p>
      </div>
    </section>

    <section id="ingame" style="display:none">
      <div class="grid grid-2">
        <div class="card">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <div class="pill">Omgang <span id="periodLabel">1</span> / 2</div>
              <div class="timer" id="clock">00:00</div>
              <div class="small muted">Start/Stopp styrer klokken. Hendelser tidsstemples.</div>
            </div>
            <div class="grid" style="gap:8px;min-width:220px">
              <button id="btnStart" class="btn success" onclick="toggleClock()">Start</button>
              <button class="btn warn" onclick="endPeriod()">Avslutt omgang</button>
              <button class="btn ghost" onclick="openSummary(false)">Vis oppsummering</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="kpi">
            <div class="k"><div class="small muted">Mål</div><div id="kpiGoals" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Assist</div><div id="kpiAssists" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Bom</div><div id="kpiMiss" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Redning</div><div id="kpiSaves" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Baklengs</div><div id="kpiConceded" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Hendelser</div><div id="kpiEvents" style="font-size:22px;font-weight:800">0</div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Spillerhandlinger</h3>
        <div id="players" class="player-list"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Hendelseslogg</h3>
        <div class="row" style="justify-content:flex-end;margin-bottom:8px">
          <button class="btn ghost" onclick="undoLast()">Angre siste</button>
          <button class="btn ghost" onclick="downloadCSV()">Last ned CSV</button>
        </div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Omgang</th>
                <th>Tid</th>
                <th>Spiller</th>
                <th>Rolle</th>
                <th>Hendelse</th>
                <th>Assist</th>
                <th>Sone</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="eventsBody"></tbody>
          </table>
        </div>
        <div class="sticky-footer row" style="justify-content:space-between">
          <div class="small muted">Data lagres lokalt til du sender inn.</div>
          <div class="row">
            <button class="btn" onclick="goBackToSetup()">Tilbake til oppsett</button>
            <button class="btn primary" onclick="submitToSheets()">Send inn kamp → Google-ark</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Summary Modal -->
  <div id="summaryModal" class="modal" role="dialog" aria-modal="true" aria-label="Oppsummering">
    <div class="content">
      <h3 style="margin-top:0">Oppsummering</h3>
      <div class="row" style="align-items:center;gap:10px">
        <label>Periode
          <select id="summaryPeriod">
            <option value="1" selected>1. omgang</option>
            <option value="2">2. omgang</option>
            <option value="all">Hele kampen</option>
          </select>
        </label>
        <button class="btn" onclick="renderSummary()">Oppdater</button>
      </div>
      <div id="summaryBody" style="margin-top:8px"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeSummary()">Lukk</button>
      </div>
    </div>
  </div>

  <!-- Goal Modal -->
  <div id="goalModal" class="modal" role="dialog" aria-modal="true" aria-label="Registrer mål">
    <div class="content">
      <h3 style="margin-top:0">Registrer mål</h3>
      <div id="goalWho" class="small muted" style="margin-bottom:8px"></div>
      <div class="section-title">Sone</div>
      <div id="goalZone" class="zone-wrap" style="margin-bottom:8px"></div>
      <div class="section-title">Assist – valgfritt</div>
      <div id="assistList" class="list"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeGoalModal()">Lukk</button>
      </div>
    </div>
  </div>

  <!-- Miss Modal -->
  <div id="missModal" class="modal" role="dialog" aria-modal="true" aria-label="Registrer bom">
    <div class="content">
      <h3 style="margin-top:0">Registrer bom</h3>
      <div id="missWho" class="small muted" style="margin-bottom:8px"></div>
      <div class="section-title">Sone</div>
      <div id="missZone" class="zone-wrap"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeMissModal()">Lukk</button>
      </div>
    </div>
  </div>

  <!-- Concede Modal -->
  <div id="concedeModal" class="modal" role="dialog" aria-modal="true" aria-label="Registrer mål (imot)">
    <div class="content">
      <h3 style="margin-top:0">Registrer mål (imot)</h3>
      <div id="concedeWho" class="small muted" style="margin-bottom:8px"></div>
      <div class="section-title">Sone</div>
      <div id="concedeZone" class="zone-wrap"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeConcedeModal()">Lukk</button>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div id="saveModal" class="modal" role="dialog" aria-modal="true" aria-label="Registrer redning">
    <div class="content">
      <h3 style="margin-top:0">Registrer redning (sone)</h3>
      <div id="saveWho" class="small muted" style="margin-bottom:8px"></div>
      <div class="section-title">Sone</div>
      <div id="saveZone" class="zone-wrap"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeSaveModal()">Lukk</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-label="Rediger hendelse">
    <div class="content">
      <h3 style="margin-top:0">Rediger hendelse</h3>
      <div class="row small muted">Endre omgang, tid, spiller, hendelse, assist og sone før innsending.</div>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
        <label style="min-width:120px">Omgang
          <select id="editPeriod"></select>
        </label>
        <label style="min-width:140px">Tid (mm:ss)
          <input type="text" id="editTime" placeholder="mm:ss" />
        </label>
        <label style="min-width:180px">Spiller
          <select id="editPlayer"></select>
        </label>
        <label style="min-width:140px">Rolle
          <input type="text" id="editRole" readonly />
        </label>
        <label style="min-width:180px">Hendelse
          <select id="editType"></select>
        </label>
        <label style="min-width:180px">Assist (valgfritt)
          <select id="editAssist"></select>
        </label>
      </div>
      <div class="section-title">Sone</div>
      <div id="editZone" class="zone-wrap" style="margin-bottom:8px"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeEditModal()">Avbryt</button>
        <button class="btn success" onclick="saveEditedEvent()">Lagre</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZW7x8lC4mxIy0ubb4f1HUvEd9Qw6IPOI9mmT33wAE7FcyzUKZurxxuR-_i3RgWeLS/exec";
    const DEFAULT_ROSTER = [ { name:'Jacob', role:'Utespiller', star:false, attending:false },
      { name:'Patrick F', role:'Målvakt', star:false, attending:false },
      { name:'Jonas', role:'Utespiller', star:false, attending:false },
      { name:'Mats', role:'Utespiller', star:false, attending:false },
      { name:'Theodor', role:'Utespiller', star:false, attending:false },
      { name:'Ulrik', role:'Målvakt', star:false, attending:false },
      { name:'Loke', role:'Utespiller', star:false, attending:false },
      { name:'Sebastian', role:'Utespiller', star:false, attending:false },
      { name:'Mateo', role:'Utespiller', star:false, attending:false },
      { name:'Markus', role:'Utespiller', star:false, attending:false },
      { name:'Demyd', role:'Utespiller', star:false, attending:false },
      { name:'Theo', role:'Målvakt', star:false, attending:false },
      { name:'Stokka', role:'Utespiller', star:false, attending:false },
      { name:'Fabian', role:'Utespiller', star:false, attending:false },
      { name:'Nicolay', role:'Utespiller', star:false, attending:false },
      { name:'Felix', role:'Utespiller', star:false, attending:false },
      { name:'Ole', role:'Utespiller', star:false, attending:false },
      { name:'Patrick W.', role:'Utespiller', star:false, attending:false },
      { name:'Oskar', role:'Utespiller', star:false, attending:false },
      { name:'Adrian A', role:'Utespiller', star:false, attending:false },
      { name:'Adrian B', role:'Utespiller', star:false, attending:false } ];
    const LS_KEY = 'handball_stats_no_v22d';

    const state = {
      metadata: { date: new Date().toISOString().slice(0,10), opponent: '', notes: '', competition: 'Annet', periodMinutes: 30 },
      players: [],
      currentPeriod: 1,
      clock: { running:false, startMs:0, elapsedMs:0 },
      periodStarted: {1:false, 2:false},
      events: [],
      goalForm: { player:'', zone:null, assist:'' },
      missForm: { player:'', zone:null },
      concedeForm: { player:'', zone:null },
      saveForm: { player:'', zone:null },
      lastZoneByPlayer: {},
      editIndex: -1,
      editZone: null,
    };

    const $ = (id)=> document.getElementById(id);

    function init(){
      state.players = DEFAULT_ROSTER.map(p=>({ name:p.name, role:p.role, star:p.star||false, attending:p.attending||false }));
      renderRoster();
      restoreLocalIfAny();
      renderRoster();
      onCompetitionChange();
    }

    function byPref(a,b){ if(a.star!==b.star) return a.star? -1 : 1; if(a.role!==b.role){ if(a.role==='Målvakt') return -1; if(b.role==='Målvakt') return 1; } return a.name.localeCompare(b.name); }
    function rosterSorted(){ return state.players.slice().sort(byPref); }

    function renderRoster(){ const list=$('rosterList'); if(!list) return; list.innerHTML=''; rosterSorted().forEach(p=>{ const item=document.createElement('div'); item.className='badge'+(p.attending?' active':''); item.innerHTML = `
      <div class="top"><span class="nm">${p.name}</span>
        <button class="starbtn ${p.star?'on':''}" title="Favoritt" onclick="event.stopPropagation(); toggleStar('${p.name}')">★</button>
      </div>`; item.onclick=()=>{ p.attending=!p.attending; renderRoster(); persistLocal(); }; list.appendChild(item); }); }

    function toggleStar(name){ const p=state.players.find(x=>x.name===name); if(!p) return; p.star=!p.star; renderRoster(); persistLocal(); renderPlayers(); }
    function markFieldPlayersAttending(){ state.players.forEach(p=>{ if(p.role==='Utespiller') p.attending=true; }); renderRoster(); persistLocal(); }
    function markAllAttending(){ state.players.forEach(p=> p.attending=true ); renderRoster(); persistLocal(); }
    function selectNone(){ state.players.forEach(p=> p.attending=false ); renderRoster(); persistLocal(); }

    function onCompetitionChange(){ const comp=$('competition').value; state.metadata.competition=comp; const minutesInput=$('periodMinutes'); if(comp==='Regional'||comp==='Lokal'){ state.metadata.periodMinutes=25; minutesInput.value=25; minutesInput.disabled=true; } else { minutesInput.disabled=false; } persistLocal(); }

    function startGame(){ state.metadata.opponent=$('opponent').value.trim(); state.metadata.notes=$('notes').value.trim(); state.metadata.periodMinutes=Math.max(1,parseInt($('periodMinutes').value||String(state.metadata.periodMinutes),10)); if(state.players.every(p=>!p.attending)){ state.players.forEach(p=> p.attending=true); renderRoster(); }
      $('setup').style.display='none'; $('ingame').style.display='block'; state.currentPeriod=1; state.clock={running:false,startMs:0,elapsedMs:0}; state.periodStarted={1:false,2:false}; $('periodLabel').textContent='1'; updateClockUI(); setStartButton(false); renderPlayers(); renderEvents(); persistLocal(); }

    function goBackToSetup(){ $('ingame').style.display='none'; $('setup').style.display='grid'; renderRoster(); persistLocal(); }

    // ===== Clock =====
    let _tickHandle=null; function toggleClock(){ if(state.clock.running){ state.clock.running=false; clearInterval(_tickHandle); _tickHandle=null; setStartButton(false); } else { state.clock.running=true; state.clock.startMs=Date.now()-state.clock.elapsedMs; _tickHandle=setInterval(tick,250); setStartButton(true); state.periodStarted[state.currentPeriod]=true; } persistLocal(); }
    function tick(){ const periodMs=state.metadata.periodMinutes*60*1000; state.clock.elapsedMs=Math.min(periodMs, Date.now()-state.clock.startMs); updateClockUI(); if(state.clock.elapsedMs>=periodMs){ endPeriod(); } }
    function updateClockUI(){ $('clock').textContent = millisToClock(state.clock.elapsedMs); }
    function setStartButton(running){ const b=$('btnStart'); if(!b) return; if(running){ b.textContent='Stopp'; b.classList.remove('success'); } else { b.textContent='Start'; b.classList.add('success'); } }
    function millisToClock(ms){ const t=Math.floor(ms/1000), mm=String(Math.floor(t/60)).padStart(2,'0'), ss=String(t%60).padStart(2,'0'); return `${mm}:${ss}`; }
    function nowClock(){ return millisToClock(state.clock.elapsedMs); }
    function ensurePeriodStarted(){ if(!state.periodStarted[state.currentPeriod]){ alert('Start klokken i denne omgangen før du registrerer hendelser.'); return false; } return true; }
    function endPeriod(){ if(state.currentPeriod===1){ state.currentPeriod=2; $('periodLabel').textContent='2'; state.clock={running:false,startMs:0,elapsedMs:0}; clearInterval(_tickHandle); _tickHandle=null; setStartButton(false); state.periodStarted[2]=false; openSummary(false); } else { state.clock.running=false; clearInterval(_tickHandle); _tickHandle=null; setStartButton(false); updateClockUI(); alert('2. omgang er slutt. Du kan fortsatt se/oppsummere og sende inn kampen.'); } persistLocal(); }

    // ===== Players (GK-first with star priority) =====
    function sortedAttending(){ return state.players.filter(p=>p.attending).slice().sort(byPref); }
    function renderPlayers(){ const container=$('players'); if(!container) return; container.innerHTML=''; const attending=sortedAttending(); attending.forEach(p=>{ const div=document.createElement('div'); div.className='player'; let actions=''; if(p.role==='Målvakt'){ actions = `<button class="btn success" onclick="if(ensurePeriodStarted()) openSaveModal('${p.name}')">Redning</button><button class="btn danger" onclick="if(ensurePeriodStarted()) openConcedeModal('${p.name}')">Mål</button>`; } else { actions = `<button class="btn success" onclick="if(ensurePeriodStarted()) openGoalModal('${p.name}')">Mål</button><button class="btn warn" onclick="if(ensurePeriodStarted()) openMissModal('${p.name}')">Bom</button><button class="btn danger" onclick="if(ensurePeriodStarted()) addEvent('${p.name}','Utespiller','Teknisk')">Teknisk</button>`; }
      div.innerHTML = `<h4><span>${p.name}</span> <button class="starbtn ${p.star?'on':''}" title="Favoritt" onclick="toggleStar('${p.name}')">★</button></h4><div class="actions">${actions}</div>`; container.appendChild(div); }); }

    // ===== Events & log =====
    function addEvent(player, role, type, assist='', zone=''){ const ev={ period: state.currentPeriod, time: nowClock(), player, role, type, assist, zone }; state.events.push(ev); renderEvents(); persistLocal(); }
    function renderEvents(){ const body=$('eventsBody'); body.innerHTML=''; state.events.forEach((ev,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td class="small muted">${i+1}</td><td>${ev.period}</td><td>${ev.time}</td><td>${ev.player}</td><td class="small muted">${ev.role}</td><td>${ev.type}</td><td>${ev.assist||''}</td><td>${ev.zone||''}</td><td><button class="btn ghost" onclick="openEdit(${i})">Rediger</button> <button class="btn ghost" onclick="deleteEvent(${i})">Slett</button></td>`; body.appendChild(tr); }); updateKPIs(); }
    function updateKPIs(){ const goals = state.events.filter(e=>e.type==='Mål' && e.role==='Utespiller').length; const assists = state.events.filter(e=>e.assist).length; const miss = state.events.filter(e=>e.type==='Bom').length; const saves = state.events.filter(e=>e.type==='Redning').length; const conceded = state.events.filter(e=>e.type==='Baklengsmål' || (e.type==='Mål' && e.role==='Målvakt')).length; $('kpiGoals').textContent=goals; $('kpiAssists').textContent=assists; $('kpiMiss').textContent=miss; $('kpiSaves').textContent=saves; $('kpiConceded').textContent=conceded; $('kpiEvents').textContent=state.events.length; }
    function undoLast(){ state.events.pop(); renderEvents(); persistLocal(); }
    function deleteEvent(i){ if(!confirm('Slette denne hendelsen?')) return; state.events.splice(i,1); renderEvents(); persistLocal(); }

    // ===== Inline zone SVG =====
    function zoneSVG(selected){ const sel=(z)=> (String(selected)==String(z) ? ' selected' : ''); return `
      <svg class="zone" viewBox="0 0 776 464" xmlns="http://www.w3.org/2000/svg" aria-label="Skuddsoner">
        <rect x="0" y="0" width="776" height="464" rx="20" fill="#7bb7da"/>
        <path class="goal" d="M200,0 H576 V140 C576,140 500,230 388,230 276,230 200,140 200,140 Z"/>
        <path class="nine" d="M70,180 A470,470 0 0 0 706,180"/>
        <path class="six" d="M310,240 Q388,220 466,240"/>
        ${numBtn(1, 110,190, sel(1))}
        ${numBtn(2, 320,220, sel(2))}
        ${numBtn(3, 388,230, sel(3))}
        ${numBtn(4, 456,220, sel(4))}
        ${numBtn(5, 666,190, sel(5))}
        ${numBtn(6, 220,320, sel(6))}
        ${numBtn(7, 388,360, sel(7))}
        ${numBtn(8, 556,320, sel(8))}
        ${textBtn('7m', 388,100, sel('7m'))}
      </svg>`; }
    function numBtn(n,x,y,cls){ return `<g class="numbtn${cls}" data-zone="${n}"><circle cx="${x}" cy="${y}" r="22"></circle><text x="${x}" y="${y}">${n}</text></g>`; }
    function textBtn(label,x,y,cls){ return `<g class="numbtn${cls}" data-zone="${label}"><circle cx="${x}" cy="${y}" r="22"></circle><text x="${x}" y="${y}">${label}</text></g>`; }

    function renderZonePicker(targetId, selected, onSelect){ const tgt=$(targetId); tgt.innerHTML=zoneSVG(selected); tgt.querySelectorAll('[data-zone]').forEach(el=>{ el.addEventListener('click', ()=>{ const z=el.dataset.zone; onSelect(isNaN(parseInt(z,10))?z:parseInt(z,10)); tgt.querySelectorAll('.numbtn').forEach(a=>a.classList.remove('selected')); el.classList.add('selected'); }); }); }

    // ===== Goal / Miss / Concede / Save =====
    function openGoalModal(player){ state.goalForm = { player, zone: state.lastZoneByPlayer[player] || null, assist:'' }; $('goalWho').textContent = `${player}`; renderZonePicker('goalZone', state.goalForm.zone, (z)=>{ state.goalForm.zone=z; renderAssistList(); }); renderAssistList(); $('goalModal').style.display='flex'; }
    function renderAssistList(){ const list=$('assistList'); list.innerHTML=''; const scorer=state.goalForm.player; const attending=state.players.filter(p=>p.attending && p.name!==scorer); const noneBtn=document.createElement('button'); noneBtn.className='btn ghost'; noneBtn.textContent='Ingen assist'; noneBtn.style.margin='0 0 8px 0'; noneBtn.onclick=()=>{ state.goalForm.assist=''; confirmGoal(); }; if(!state.goalForm.zone){ noneBtn.disabled=true; } list.appendChild(noneBtn); attending.forEach(p=>{ const b=document.createElement('button'); b.className='btn'; b.style.display='block'; b.style.width='100%'; b.style.margin='4px 0'; b.textContent=p.name; b.onclick=()=>{ state.goalForm.assist=p.name; confirmGoal(); }; if(!state.goalForm.zone){ b.disabled=true; } list.appendChild(b); }); }
    function closeGoalModal(){ $('goalModal').style.display='none'; }
    function confirmGoal(){ const g=state.goalForm; addEvent(g.player,'Utespiller','Mål',g.assist||'',String(g.zone||'')); state.lastZoneByPlayer[g.player]=g.zone; closeGoalModal(); }

    function openMissModal(player){ state.missForm = { player, zone: state.lastZoneByPlayer[player] || null }; $('missWho').textContent = `${player}`; renderZonePicker('missZone', state.missForm.zone, (z)=>{ state.missForm.zone=z; confirmMiss(); }); $('missModal').style.display='flex'; }
    function closeMissModal(){ $('missModal').style.display='none'; }
    function confirmMiss(){ const m=state.missForm; addEvent(m.player,'Utespiller','Bom','',String(m.zone||'')); state.lastZoneByPlayer[m.player]=m.zone; closeMissModal(); }

    function openConcedeModal(player){ state.concedeForm = { player, zone: state.lastZoneByPlayer[player] || null }; $('concedeWho').textContent = `${player}`; renderZonePicker('concedeZone', state.concedeForm.zone, (z)=>{ state.concedeForm.zone=z; confirmConcede(); }); $('concedeModal').style.display='flex'; }
    function closeConcedeModal(){ $('concedeModal').style.display='none'; }
    function confirmConcede(){ const c=state.concedeForm; addEvent(c.player,'Målvakt','Baklengsmål','',String(c.zone||'')); state.lastZoneByPlayer[c.player]=c.zone; closeConcedeModal(); }

    function openSaveModal(player){ state.saveForm = { player, zone: state.lastZoneByPlayer[player] || null }; $('saveWho').textContent = `${player}`; renderZonePicker('saveZone', state.saveForm.zone, (z)=>{ state.saveForm.zone=z; confirmSave(); }); $('saveModal').style.display='flex'; }
    function closeSaveModal(){ $('saveModal').style.display='none'; }
    function confirmSave(){ const s=state.saveForm; addEvent(s.player,'Målvakt','Redning','',String(s.zone||'')); state.lastZoneByPlayer[s.player]=s.zone; closeSaveModal(); }

    // ===== Edit modal logic =====
    function openEdit(i){ state.editIndex=i; const ev=state.events[i]; // Period
      const pSel=$('editPeriod'); pSel.innerHTML='<option value="1">1</option><option value="2">2</option>'; pSel.value=String(ev.period);
      // Time
      $('editTime').value=ev.time;
      // Players
      const plSel=$('editPlayer'); plSel.innerHTML = state.players.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''); plSel.value=ev.player;
      // Role based on selected player
      const role = (state.players.find(p=>p.name===plSel.value)||{role:ev.role}).role; $('editRole').value=role;
      // Type
      buildTypeOptions(role, ev.type);
      // Assist
      buildAssistOptions(plSel.value, ev.assist, $('editType').value);
      // Zone
      state.editZone = ev.zone || null; renderZonePicker('editZone', state.editZone, z=>{ state.editZone=z; });
      // Handlers
      plSel.onchange = ()=>{ const r=(state.players.find(p=>p.name===plSel.value)||{role:'Utespiller'}).role; $('editRole').value=r; buildTypeOptions(r, (r==='Utespiller'?'Mål':'Redning')); buildAssistOptions(plSel.value, '', $('editType').value); };
      $('editType').onchange = ()=>{ buildAssistOptions(plSel.value, ev.assist, $('editType').value); };
      $('editModal').style.display='flex'; }

    function buildTypeOptions(role, current){ const tSel=$('editType'); if(role==='Målvakt'){ tSel.innerHTML = ['Redning','Baklengsmål'].map(t=>`<option value="${t}">${t}</option>`).join(''); } else { tSel.innerHTML = ['Mål','Bom','Teknisk'].map(t=>`<option value="${t}">${t}</option>`).join(''); } tSel.value=current; }

    function buildAssistOptions(playerName, currentAssist, currentType){ const aSel=$('editAssist'); const others = state.players.filter(p=>p.attending && p.name!==playerName); let opts = `<option value="">Ingen</option>`; opts += others.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''); aSel.innerHTML=opts; aSel.value = currentAssist||''; // Only enable for field goals
      aSel.disabled = !( $('editRole').value==='Utespiller' && currentType==='Mål' ); }

    function closeEditModal(){ $('editModal').style.display='none'; state.editIndex=-1; state.editZone=null; }

    function saveEditedEvent(){ const i=state.editIndex; if(i<0) return; const ev=state.events[i]; const period = parseInt($('editPeriod').value,10)||ev.period; const time = $('editTime').value||ev.time; const player = $('editPlayer').value||ev.player; const role = $('editRole').value||ev.role; const type = $('editType').value||ev.type; const assist = $('editAssist').disabled? '' : $('editAssist').value; const zone = String(state.editZone||''); state.events[i] = { period, time, player, role, type, assist, zone }; closeEditModal(); renderEvents(); persistLocal(); }

    // ===== Summary =====
    function openSummary(){ $('summaryModal').style.display='flex'; renderSummary(); }
    function closeSummary(){ $('summaryModal').style.display='none'; }
    function renderSummary(){
      const periodSel = $('summaryPeriod').value; const zones = ['1','2','3','4','5','6','7','8','7m'];
      const ourGoals = Object.fromEntries(zones.map(z=>[z,0]));
      const ourMiss  = Object.fromEntries(zones.map(z=>[z,0]));
      const oppConceded = Object.fromEntries(zones.map(z=>[z,0]));
      const oppSaved    = Object.fromEntries(zones.map(z=>[z,0]));
      const periodFilter = (e)=> periodSel==='all' ? true : e.period===parseInt(periodSel,10);

      state.events.filter(periodFilter).forEach(e=>{
        const z = String(e.zone||''); if(!zones.includes(z)) return;
        if(e.role==='Utespiller'){
          if(e.type==='Mål') ourGoals[z]++;
          if(e.type==='Bom') ourMiss[z]++;
        } else if(e.role==='Målvakt'){
          if(e.type==='Baklengsmål' || e.type==='Mål') oppConceded[z]++;
          if(e.type==='Redning') oppSaved[z]++;
        }
      });

      const totOurGoals = Object.values(ourGoals).reduce((a,b)=>a+b,0);
      const totOurShots = Object.keys(ourGoals).reduce((sum,z)=> sum + ourGoals[z] + ourMiss[z], 0);
      const ourConv = totOurShots>0 ? Math.round(100*totOurGoals/totOurShots) : 0;
      const totOppConceded = Object.values(oppConceded).reduce((a,b)=>a+b,0);
      const totOppShots = Object.keys(oppConceded).reduce((sum,z)=> sum + oppConceded[z] + oppSaved[z], 0);
      const oppConv = totOppShots>0 ? Math.round(100*totOppConceded/totOppShots) : 0;

      const body = $('summaryBody'); body.innerHTML='';
      const header = document.createElement('div'); header.innerHTML = `<div class="row" style="justify-content:space-between"><div class="pill">Våre: ${totOurGoals}/${totOurShots} (${ourConv}%)</div><div class="pill">Motstander: ${totOppConceded}/${totOppShots} (${oppConv}%)</div></div>`; body.appendChild(header);

      const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(3,1fr)'; grid.style.gap='10px';
      ['1','2','3','4','5','6','7','8','7m'].forEach(z=>{
        const oShots = ourGoals[z] + ourMiss[z]; const oConv = oShots>0 ? Math.round(100*ourGoals[z]/oShots) : 0;
        const pShots = oppConceded[z] + oppSaved[z]; const pConv = pShots>0 ? Math.round(100*oppConceded[z]/pShots) : 0;
        const card = document.createElement('div'); card.className='card'; card.style.padding='10px';
        card.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Sone ${z}</div>
          <div class="small muted">Våre: ${ourGoals[z]}/${oShots} (${oConv}%)</div>
          <div class="bar"><span style="width:${oConv}%"></span></div>
          <div class="small muted" style="margin-top:6px">Motstander: ${oppConceded[z]}/${pShots} (${pConv}%)</div>
          <div class="bar bad"><span style="width:${pConv}%"></span></div>`;
        grid.appendChild(card);
      });
      body.appendChild(grid);
    }

    // ===== Storage & CSV =====
    function persistLocal(){ localStorage.setItem(LS_KEY, JSON.stringify({ state })); }
    function restoreLocalIfAny(){ const raw=localStorage.getItem(LS_KEY); if(!raw) return; try{ const snap=JSON.parse(raw); if(snap && snap.state){ Object.assign(state, snap.state); } }catch{}; $('opponent').value=state.metadata.opponent||''; $('notes').value=state.metadata.notes||''; $('competition').value=state.metadata.competition||'Annet'; $('periodMinutes').value=state.metadata.periodMinutes||30; }
    function loadFromLocal(){ restoreLocalIfAny(); renderRoster(); alert('Lastet inn lagret kampdata.'); }
    function clearLocal(){ localStorage.removeItem(LS_KEY); alert('Tømt lagrede kampdata lokalt.'); }

    function downloadCSV(){ const header=['Dato','Motstander','Konkurranse','Merknader','Omgang','Tid','Spiller','Rolle','Hendelse','Assist','Sone']; const rows=state.events.map(ev=>[ state.metadata.date, state.metadata.opponent||'', state.metadata.competition||'', state.metadata.notes||'', ev.period, ev.time, ev.player, ev.role, ev.type, ev.assist||'', ev.zone||'' ]); const csv=[header].concat(rows).map(r=>r.map(x=>`"${String(x).replace(/\"/g,'\"\"')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`handball_stats_${state.metadata.date}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    // Boot
    init();
  </script>
</body>
</html>
