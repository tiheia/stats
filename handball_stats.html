
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handball Game Stats – Simple Tracker</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2b; --accent:#4cc9f0; --accent2:#c77dff;
      --text:#e6f1ff; --muted:#9fb3c8; --bad:#ef476f; --ok:#06d6a0; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    header{padding:12px 16px;background:linear-gradient(90deg,var(--panel),#0f1a33)}
    h1{margin:0;font-size:20px}
    main{padding:16px;max-width:1100px;margin:auto}
    .grid{display:grid;gap:12px}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    input[type="text"],input[type="number"],select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2a3a5c;background:#0f1730;color:var(--text)}
    .btn{appearance:none;border:1px solid #244; background:#0f1730; color:#e6f1ff; padding:10px 12px; border-radius:10px; cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#2895be); border-color:#1d6b87; color:#062231; font-weight:700}
    .btn.success{background:linear-gradient(180deg,var(--ok),#0ab77f); border-color:#0a8f66; color:#062231; font-weight:700}
    .btn.warn{background:linear-gradient(180deg,var(--warn),#e3b23b); border-color:#b9902f; color:#3d2b00; font-weight:700}
    .btn.danger{background:linear-gradient(180deg,var(--bad),#cc3557); border-color:#9c2a44; color:#33010f; font-weight:700}
    .btn.ghost{background:transparent;border-color:#2a3a5c}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .timer{font-variant-numeric:tabular-nums;font-size:40px;font-weight:800;letter-spacing:1px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0b1430;border:1px solid #2a3a5c;color:var(--muted);font-size:12px}
    .player-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .player{padding:12px;border:1px solid #1f2a44;border-radius:12px;background:#0e1833}
    .player h4{margin:0 0 8px 0}
    .player .role{font-size:12px;color:var(--muted)}
    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
    .actions .wide{grid-column:1/-1}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #22324f}
    tr:hover{background:#0f1a35}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .kpi .k{background:#0e1833;border:1px solid #1f2a44;border-radius:12px;padding:10px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .sticky-footer{position:sticky;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(11,18,32,0),var(--bg) 25%);padding:12px 0;margin-top:8px}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
    .modal .content{width:min(600px,92vw);background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:12px}
    .modal .list{max-height:42vh;overflow:auto}
    .section-title{margin:8px 0 6px;color:var(--muted);font-size:13px}

    /* Zone SVG styles */
    .zone-wrap{width:100%;}
    svg.zone{width:100%;height:auto;border-radius:12px;background:#7bb7da}
    .zone .court{fill:#76b6d8}
    .zone .six{fill:#0b4a78}
    .zone .goal{fill:#073656}
    .zone .nine{fill:none;stroke:#fff;stroke-dasharray:8 6;opacity:.8}
    .zone .redline{fill:none;stroke:#b11c4a;stroke-width:3}
    .zone .diag{stroke:#b11c4a;stroke-width:3}
    .zone .num{font-size:20px;fill:#fff;font-weight:700;text-anchor:middle}
    .zone .hit{fill:rgba(76,201,240,0);cursor:pointer}
    .zone .hit:hover{fill:rgba(76,201,240,.15)}
    .zone .hit.active{fill:rgba(76,201,240,.35);stroke:var(--accent);stroke-width:2}

    /* Mobile-friendly roster */
    .roster-list{display:grid;gap:8px}
    .roster-item{display:grid;gap:6px;padding:10px;border:1px solid #1f2a44;border-radius:12px;background:#0e1833}
    .roster-item .top{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .name-input{flex:1;min-width:0}
    .toggle{display:flex;align-items:center;gap:6px}
    .seg{display:flex;gap:6px;flex-wrap:wrap}
    .seg .opt{padding:6px 10px;border-radius:999px;border:1px solid #2a3a5c;background:#0f1730;color:#e6f1ff;cursor:pointer}
    .seg .opt.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(76,201,240,.25) inset}
  </style>
</head>
<body>
  <header>
    <h1>Handball Game Stats – Simple Tracker</h1>
  </header>
  <main>
    <!-- PRE-GAME SETUP -->
    <section id="setup" class="grid grid-2">
      <div class="card">
        <h2 style="margin-top:0">1) Game details</h2>
        <label>Competition
          <select id="competition" onchange="onCompetitionChange()">
            <option value="Regional">Regional</option>
            <option value="Lokal">Lokal</option>
            <option value="Annet" selected>Annet</option>
          </select>
        </label>
        <label>Opponent (optional)
          <input id="opponent" type="text" placeholder="Opponent name" />
        </label>
        <label>Notes (optional)
          <input id="notes" type="text" placeholder="League, friendly, etc." />
        </label>
        <div class="row" style="align-items:center;justify-content:space-between;margin-top:8px">
          <div style="flex:1">
            <label>Period length (minutes)
              <input id="periodMinutes" type="number" min="1" max="60" value="30" />
            </label>
            <div class="small muted">Regional/Lokal: auto 25 min. Annet: choose freely.</div>
          </div>
          <div>
            <span class="pill">Two periods</span>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost" onclick="loadFromLocal()">Load last unsent game</button>
          <button class="btn ghost" onclick="clearLocal()">Clear local</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0">2) Select attending players</h2>
        <div class="row" style="margin-bottom:8px">
          <button class="btn success" onclick="markFieldPlayersAttending()">Mark all field players attending</button>
          <button class="btn" onclick="selectNone()">Clear attending</button>
          <button class="btn" onclick="addCustomPlayer()">+ Add player</button>
        </div>
        <div id="rosterList" class="roster-list"></div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h2 style="margin-top:0">3) Start game</h2>
        <div class="row">
          <button class="btn primary" onclick="startGame()">Start Game (go to Period 1)</button>
        </div>
        <p class="small muted">Tip: you can always come back to setup before submitting.</p>
      </div>
    </section>

    <!-- IN-GAME -->
    <section id="ingame" style="display:none">
      <div class="grid grid-2">
        <div class="card">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <div class="pill">Period <span id="periodLabel">1</span> / 2</div>
              <div class="timer" id="clock">00:00</div>
              <div class="small muted">Tap Start/Stop to control the clock. Events are time‑stamped.</div>
            </div>
            <div class="grid" style="gap:8px;min-width:220px">
              <button id="btnStart" class="btn success" onclick="toggleClock()">Start</button>
              <button class="btn warn" onclick="endPeriod()">End current period</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="kpi">
            <div class="k"><div class="small muted">Goals</div><div id="kpiGoals" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Assists</div><div id="kpiAssists" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Misses</div><div id="kpiMiss" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Saves</div><div id="kpiSaves" style="font-size:22px;font-weight:800">0</div></div>
            <div class="k"><div class="small muted">Conceded</div><div id="kpiConceded" style="font-size:22px;font-weight:800">0</div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Quick actions</h3>
        <div id="players" class="player-list"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Event log</h3>
        <div class="row" style="justify-content:flex-end;margin-bottom:8px">
          <button class="btn ghost" onclick="undoLast()">Undo last</button>
          <button class="btn ghost" onclick="downloadCSV()">Download CSV</button>
        </div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Period</th>
                <th>Time</th>
                <th>Player</th>
                <th>Role</th>
                <th>Event</th>
                <th>Assist</th>
                <th>Zone</th>
              </tr>
            </thead>
            <tbody id="eventsBody"></tbody>
          </table>
        </div>
        <div class="sticky-footer row" style="justify-content:space-between">
          <div class="small muted">Data is kept locally until you submit.</div>
          <div class="row">
            <button class="btn" onclick="goBackToSetup()">Back to setup</button>
            <button class="btn primary" onclick="submitToSheets()">Submit game → Google Sheet</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Goal modal (assist + visual zone picker) for Field players -->
  <div id="goalModal" class="modal" role="dialog" aria-modal="true" aria-label="Record goal">
    <div class="content">
      <h3 style="margin-top:0">Record goal</h3>
      <div id="goalWho" class="small muted" style="margin-bottom:8px"></div>
      <div id="assistSection">
        <div class="section-title">Assist (optional)</div>
        <div id="assistList" class="list"></div>
      </div>
      <div class="section-title">Zone (tap on the court)</div>
      <div id="goalZone" class="zone-wrap"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeGoalModal()">Cancel</button>
        <button id="btnSaveGoal" class="btn success" onclick="confirmGoal()" disabled>Save goal</button>
      </div>
    </div>
  </div>

  <!-- Conceded modal (visual zone picker) for Goalkeepers -->
  <div id="concedeModal" class="modal" role="dialog" aria-modal="true" aria-label="Record conceded goal">
    <div class="content">
      <h3 style="margin-top:0">Record conceded goal</h3>
      <div id="concedeWho" class="small muted" style="margin-bottom:8px"></div>
      <div class="section-title">Zone (tap on the court)</div>
      <div id="concedeZone" class="zone-wrap"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeConcedeModal()">Cancel</button>
        <button id="btnSaveConcede" class="btn danger" onclick="confirmConcede()" disabled>Save conceded</button>
      </div>
    </div>
  </div>

  <script>
    // ======== CONFIG ========
    const GOOGLE_SCRIPT_URL = https://script.google.com/macros/s/AKfycbxruXaKx3QmFAMbJttYi7y6MY1Na_WETAcyb4_Lg6u35TwFqIb52E10aYJW2SOQWdNM_g/exec; // e.g., https://script.google.com/macros/s/AKfycbx.../exec

    // Default roster with 3 goalkeepers
    const DEFAULT_ROSTER = [
      { name:"Theo", role:"Goalkeeper" },
      { name:"Ulrik", role:"Goalkeeper" },
      { name:"Patrick F", role:"Goalkeeper" },
      { name:"Per", role:"Field" },
      { name:"Paal", role:"Field" },
      { name:"Espen", role:"Field" },
      { name:"Truls", role:"Field" },
      { name:"Ole", role:"Field" }
    ];

    // ======== STATE ========
    const state = {
      metadata: { date: new Date().toISOString().slice(0,10), opponent: "", notes: "", competition: 'Annet', periodMinutes: 30 },
      players: [], // {name, role: 'Field'|'Goalkeeper', attending: true|false}
      attending: [], // names
      currentPeriod: 1,
      clock: { running:false, startMs:0, elapsedMs:0 },
      events: [], // {period, time, player, role, type, assist, zone}
      goalForm: { player:"", assist:"", zone:null },
      concedeForm: { player:"", zone:null },
    };

    function $(id){ return document.getElementById(id); }

    // ======== SETUP ROSTER UI ========
    function init(){
      state.players = DEFAULT_ROSTER.map(p => ({ name:p.name, role:p.role, attending:false }));
      renderRoster();
      restoreLocalIfAny();
      onCompetitionChange();
    }

    function renderRoster(){
      const list = $("rosterList");
      list.innerHTML = '';
      state.players.forEach((p, idx) => {
        const item = document.createElement('div'); item.className='roster-item';
        item.innerHTML = `
          <div class=\"top\">
            <input class=\"name-input\" type=\"text\" value=\"${p.name}\" data-idx=\"${idx}\" oninput=\"onRename(event)\" />
            <label class=\"toggle\"><input type=\"checkbox\" data-idx=\"${idx}\" ${p.attending?'checked':''} onchange=\"onAttendToggle(event)\" /> Attending</label>
          </div>
          <div class=\"seg\">
            <button class=\"opt ${p.role==='Field'?'active':''}\" data-idx=\"${idx}\" data-role=\"Field\" onclick=\"onRoleClick(event)\">Field</button>
            <button class=\"opt ${p.role==='Goalkeeper'?'active':''}\" data-idx=\"${idx}\" data-role=\"Goalkeeper\" onclick=\"onRoleClick(event)\">Goalkeeper</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    function onRename(e){ const i=+e.target.dataset.idx; state.players[i].name = e.target.value.trim(); persistLocal(); }
    function onAttendToggle(e){ const i=+e.target.dataset.idx; state.players[i].attending = e.target.checked; persistLocal(); }
    function onRoleClick(e){ const i=+e.target.dataset.idx; const r=e.target.dataset.role; state.players[i].role = r; renderRoster(); persistLocal(); }

    function addCustomPlayer(){ state.players.push({name:"New Player", role:'Field', attending:true}); renderRoster(); persistLocal(); }
    function markFieldPlayersAttending(){ state.players.forEach(p=>{ if(p.role==='Field') p.attending=true; }); renderRoster(); persistLocal(); }
    function selectNone(){ state.players.forEach(p=> p.attending=false ); renderRoster(); persistLocal(); }

    // ======== COMPETITION & PERIOD MINUTES ========
    function onCompetitionChange(){
      const compSel = $("competition");
      const comp = compSel.value; state.metadata.competition = comp;
      const minutesInput = $("periodMinutes");
      if(comp === 'Regional' || comp === 'Lokal'){
        state.metadata.periodMinutes = 25; minutesInput.value = 25; minutesInput.disabled = true;
      } else {
        minutesInput.disabled = false; // allow manual for Annet
        // keep current value
      }
      persistLocal();
    }

    // ======== GAME FLOW ========
    function startGame(){
      state.metadata.opponent = $("opponent").value.trim();
      state.metadata.notes = $("notes").value.trim();
      // competition already handled
      state.metadata.periodMinutes = Math.max(1, parseInt($("periodMinutes").value || String(state.metadata.periodMinutes), 10));
      state.attending = state.players.filter(p=>p.attending).map(p=>p.name);
      if(state.attending.length === 0){ alert('Select at least one attending player.'); return; }
      $("setup").style.display='none'; $("ingame").style.display='block';
      state.currentPeriod = 1; state.clock = {running:false,startMs:0,elapsedMs:0};
      $("periodLabel").textContent = '1'; updateClockUI(); renderPlayers(); renderEvents(); persistLocal();
    }

    function goBackToSetup(){ $("ingame").style.display='none'; $("setup").style.display='grid'; persistLocal(); }

    // ======== CLOCK ========
    let _tickHandle = null;
    function toggleClock(){
      if(state.clock.running){ state.clock.running=false; clearInterval(_tickHandle); _tickHandle=null; $("btnStart").textContent='Start'; $("btnStart").classList.add('success'); }
      else { state.clock.running=true; state.clock.startMs = Date.now() - state.clock.elapsedMs; _tickHandle = setInterval(tick, 250); $("btnStart").textContent='Stop'; $("btnStart").classList.remove('success'); }
      persistLocal();
    }
    function tick(){ const periodMs = state.metadata.periodMinutes * 60 * 1000; state.clock.elapsedMs = Math.min(periodMs, Date.now() - state.clock.startMs); updateClockUI(); if(state.clock.elapsedMs >= periodMs){ endPeriod(); } }
    function updateClockUI(){ $("clock").textContent = millisToClock(state.clock.elapsedMs); }
    function millisToClock(ms){ const t=Math.floor(ms/1000), mm=String(Math.floor(t/60)).padStart(2,'0'), ss=String(t%60).padStart(2,'0'); return `${mm}:${ss}`; }
    function nowClock(){ return millisToClock(state.clock.elapsedMs); }
    function endPeriod(){
      if(state.currentPeriod === 1){ state.currentPeriod = 2; $("periodLabel").textContent = '2'; state.clock = {running:false,startMs:0,elapsedMs:0}; clearInterval(_tickHandle); _tickHandle=null; $("btnStart").textContent='Start'; $("btnStart").classList.add('success'); alert('Period 1 ended. Start Period 2 when ready.'); }
      else { state.clock.running=false; clearInterval(_tickHandle); _tickHandle=null; updateClockUI(); alert('Period 2 ended. You can still add/edit events or submit the game.'); }
      persistLocal();
    }

    // ======== RENDER PLAYERS & ACTIONS ========
    function renderPlayers(){
      const container = $("players"); container.innerHTML = '';
      const attending = state.players.filter(p=>p.attending);
      attending.forEach(p => {
        const div = document.createElement('div'); div.className='player';
        div.innerHTML = `
          <h4>${p.name}</h4>
          <div class=\"role\">${p.role}</div>
          <div class=\"actions\">${actionsHtml(p)}</div>
        `; container.appendChild(div);
      });
    }

    function actionsHtml(p){
      if(p.role === 'Goalkeeper'){
        return `
          <button class=\"btn\" onclick=\"addEvent('${p.name}','Goalkeeper','Save')\">Save</button>
          <button class=\"btn danger wide\" onclick=\"openConcedeModal('${p.name}')\">Goal Conceded</button>
        `;
      }
      return `
        <button class=\"btn success\" onclick=\"openGoalModal('${p.name}')\">Goal</button>
        <button class=\"btn warn\" onclick=\"addEvent('${p.name}','Field','Miss')\">Miss</button>
        <button class=\"btn danger\" onclick=\"addEvent('${p.name}','Field','Technical Foul')\">Technical Foul</button>
      `;
    }

    // ======== EVENTS ========
    function addEvent(player, role, type, assist='', zone=''){
      const ev = { period: state.currentPeriod, time: nowClock(), player, role, type, assist, zone };
      state.events.push(ev); renderEvents(); persistLocal();
    }
    function renderEvents(){ const body = $("eventsBody"); body.innerHTML=''; state.events.forEach((ev, i) => { const tr = document.createElement('tr'); tr.innerHTML = `
          <td class=\"small muted\">${i+1}</td>
          <td>${ev.period}</td>
          <td>${ev.time}</td>
          <td>${ev.player}</td>
          <td class=\"small muted\">${ev.role}</td>
          <td>${ev.type}</td>
          <td>${ev.assist||''}</td>
          <td>${ev.zone||''}</td>
        `; body.appendChild(tr); }); updateKPIs(); }
    function updateKPIs(){ const goals = state.events.filter(e=>e.type==='Goal').length; const assists = state.events.filter(e=>e.assist).length; const miss = state.events.filter(e=>e.type==='Miss').length; const saves = state.events.filter(e=>e.type==='Save').length; const conceded = state.events.filter(e=>e.type==='Goal Conceded').length; $("kpiGoals").textContent = goals; $("kpiAssists").textContent = assists; $("kpiMiss").textContent = miss; $("kpiSaves").textContent = saves; $("kpiConceded").textContent = conceded; }
    function undoLast(){ state.events.pop(); renderEvents(); persistLocal(); }

    // ======== REUSABLE ZONE PICKER (SVG) ========
    function zoneSVG(selected){
      const isSel = (z) => (selected == z ? ' active' : '');
      return `
      <svg class=\"zone\" viewBox=\"0 0 554 327\" xmlns=\"http://www.w3.org/2000/svg\" aria-label=\"Handball shooting zones\">
        <rect class=\"court\" x=\"0\" y=\"0\" width=\"554\" height=\"327\" rx=\"12\"/>
        <path class=\"goal\" d=\"M140,0 H414 V60 A277,277 0 0 1 140,60 Z\"/>
        <path class=\"six\" d=\"M170,0 H384 V80 A235,235 0 0 1 170,80 Z\"/>
        <path class=\"redline\" d=\"M200,120 Q277,100 354,120\"/>
        <path class=\"nine\" d=\"M120,0 H434 V130 A277,277 0 0 1 120,130 Z\"/>
        <line class=\"diag\" x1=\"277\" y1=\"10\" x2=\"35\" y2=\"220\"/>
        <line class=\"diag\" x1=\"277\" y1=\"10\" x2=\"165\" y2=\"260\"/>
        <line class=\"diag\" x1=\"277\" y1=\"10\" x2=\"389\" y2=\"260\"/>
        <line class=\"diag\" x1=\"277\" y1=\"10\" x2=\"520\" y2=\"220\"/>
        <text class=\"num\" x=\"65\" y=\"100\">1</text>
        <text class=\"num\" x=\"205\" y=\"120\">2</text>
        <text class=\"num\" x=\"277\" y=\"140\">3</text>
        <text class=\"num\" x=\"349\" y=\"120\">4</text>
        <text class=\"num\" x=\"489\" y=\"100\">5</text>
        <text class=\"num\" x=\"140\" y=\"220\">6</text>
        <text class=\"num\" x=\"277\" y=\"250\">7</text>
        <text class=\"num\" x=\"414\" y=\"220\">8</text>
        <circle class=\"hit${isSel(1)}\" data-zone=\"1\" cx=\"65\" cy=\"100\" r=\"28\"/>
        <circle class=\"hit${isSel(2)}\" data-zone=\"2\" cx=\"205\" cy=\"120\" r=\"28\"/>
        <circle class=\"hit${isSel(3)}\" data-zone=\"3\" cx=\"277\" cy=\"140\" r=\"28\"/>
        <circle class=\"hit${isSel(4)}\" data-zone=\"4\" cx=\"349\" cy=\"120\" r=\"28\"/>
        <circle class=\"hit${isSel(5)}\" data-zone=\"5\" cx=\"489\" cy=\"100\" r=\"28\"/>
        <circle class=\"hit${isSel(6)}\" data-zone=\"6\" cx=\"140\" cy=\"220\" r=\"32\"/>
        <circle class=\"hit${isSel(7)}\" data-zone=\"7\" cx=\"277\" cy=\"250\" r=\"32\"/>
        <circle class=\"hit${isSel(8)}\" data-zone=\"8\" cx=\"414\" cy=\"220\" r=\"32\"/>
      </svg>`;
    }

    function renderZonePicker(targetId, selected, onSelect){
      const tgt = $(targetId); tgt.innerHTML = zoneSVG(selected);
      tgt.querySelectorAll('[data-zone]').forEach(el=>{ el.addEventListener('click', () => { onSelect(parseInt(el.dataset.zone,10)); }); });
    }

    // ======== GOAL (FIELD) ========
    function openGoalModal(player){
      state.goalForm = { player, assist:"", zone:null };
      $("goalWho").textContent = `${player} – Field`;
      const list = $("assistList"); list.innerHTML = '';
      const attending = state.players.filter(p=>p.attending && p.role==='Field' && p.name!==player);
      const noneBtn = document.createElement('button'); noneBtn.className='btn ghost'; noneBtn.textContent = 'No assist'; noneBtn.style.margin='0 0 8px 0'; noneBtn.onclick = () => { state.goalForm.assist=''; highlightAssist(); }; list.appendChild(noneBtn);
      attending.forEach(p=>{ const b = document.createElement('button'); b.className='btn'; b.style.display='block'; b.style.width='100%'; b.style.margin='4px 0'; b.textContent = p.name; b.onclick = () => { state.goalForm.assist=p.name; highlightAssist(); }; list.appendChild(b); });
      highlightAssist();
      renderZonePicker('goalZone', state.goalForm.zone, (z)=>{ state.goalForm.zone=z; $("btnSaveGoal").disabled = !(state.goalForm.zone); updateZoneHighlight('goalZone', z); }); $("btnSaveGoal").disabled = true; $("goalModal").style.display='flex';
    }

    function updateZoneHighlight(targetId, selected){ const tgt = $(targetId); tgt.querySelectorAll('.hit').forEach(h=>{ if(parseInt(h.dataset.zone,10)===selected) h.classList.add('active'); else h.classList.remove('active'); }); }
    function highlightAssist(){ const list = $("assistList"); Array.from(list.querySelectorAll('button')).forEach(btn => { if(btn.textContent === (state.goalForm.assist || 'No assist')) btn.style.outline='2px solid var(--accent)'; else btn.style.outline='none'; }); }
    function closeGoalModal(){ $("goalModal").style.display='none'; }
    function confirmGoal(){ const g = state.goalForm; if(!g.zone){ alert('Select a zone'); return; } addEvent(g.player,'Field','Goal',g.assist||'',String(g.zone)); closeGoalModal(); }

    // ======== CONCEDE (GOALKEEPER) ========
    function openConcedeModal(player){ state.concedeForm = { player, zone:null }; $("concedeWho").textContent = `${player} – Goalkeeper`; renderZonePicker('concedeZone', state.concedeForm.zone, (z)=>{ state.concedeForm.zone=z; $("btnSaveConcede").disabled = !(state.concedeForm.zone); updateZoneHighlight('concedeZone', z); }); $("btnSaveConcede").disabled = true; $("concedeModal").style.display='flex'; }
    function closeConcedeModal(){ $("concedeModal").style.display='none'; }
    function confirmConcede(){ const c = state.concedeForm; if(!c.zone){ alert('Select a zone'); return; } addEvent(c.player,'Goalkeeper','Goal Conceded','',String(c.zone)); closeConcedeModal(); }

    // ======== LOCAL STORAGE ========
    const LS_KEY = 'handball_stats_game_v5';
    function persistLocal(){ localStorage.setItem(LS_KEY, JSON.stringify({ state })); }
    function restoreLocalIfAny(){ const raw = localStorage.getItem(LS_KEY); if(!raw) return; try{ const snap = JSON.parse(raw); if(snap && snap.state){ Object.assign(state, snap.state); } }catch{}; $("opponent").value = state.metadata.opponent||''; $("notes").value = state.metadata.notes||''; $("competition").value = state.metadata.competition||'Annet'; $("periodMinutes").value = state.metadata.periodMinutes||30; renderRoster(); }
    function loadFromLocal(){ restoreLocalIfAny(); alert('Loaded any saved game data from this device.'); }
    function clearLocal(){ localStorage.removeItem(LS_KEY); alert('Cleared local saved data.'); }

    // ======== CSV DOWNLOAD ========
    function downloadCSV(){ const header = ['Date','Opponent','Competition','Notes','Period','Time','Player','Role','Event','Assist','Zone']; const rows = state.events.map(ev=>[ state.metadata.date, state.metadata.opponent||'', state.metadata.competition||'', state.metadata.notes||'', ev.period, ev.time, ev.player, ev.role, ev.type, ev.assist||'', ev.zone||'' ]); const csv = [header].concat(rows).map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `handball_stats_${state.metadata.date}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    // ======== SUBMIT TO GOOGLE SHEETS (Apps Script Web App) ========
    async function submitToSheets(){ if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('PASTE_WEB_APP_URL_HERE')){ alert('Please configure GOOGLE_SCRIPT_URL at the top of the file.'); return; } if(state.events.length === 0){ alert('No events to submit.'); return; } const payload = { metadata: { date: state.metadata.date, opponent: state.metadata.opponent||'', competition: state.metadata.competition||'', notes: state.metadata.notes||'', periodMinutes: state.metadata.periodMinutes }, players: state.players, events: state.events, gameId: `${state.metadata.date}_${Date.now()}` }; try{ const body = new URLSearchParams({ data: JSON.stringify(payload) }).toString(); const res = await fetch(GOOGLE_SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body }); if(!res.ok){ throw new Error('Network error'); } let msg = 'Submitted to Google Sheet.'; try{ const j = await res.json(); if(j && j.status==='ok' && j.rowsAppended){ msg += ` Rows appended: ${j.rowsAppended}`; } }catch{} alert(msg); localStorage.setItem(LS_KEY+"_backup", JSON.stringify({state})); state.events = []; renderEvents(); persistLocal(); } catch(err){ console.error(err); alert('Submit failed. Please check your internet connection and the Apps Script URL.'); } }

    // Boot
    init();
  </script>
</body>
</html>
